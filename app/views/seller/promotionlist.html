{{partial("layout/header")}}
{{stylesheet_link("leaflet/leaflet.css")}}
{{stylesheet_link("leaflet/L.Icon.Pulse.css")}}
<section id="content_wrapper">
    <div id="topbar">
        <div class="topbar-left">
            <ol class="breadcrumb">
                <li class="crumb-active"><a href="#">商家促销列表</a></li>
                <li class="crumb-icon"><a href="/{{routerProjectId}}/index/index"><span class="glyphicon glyphicon-home"></span></a></li>
                <li class="crumb-link"><a href="/{{routerProjectId}}/index/index">{{"Home"|_}}</a></li>
                <li class="crumb-trail">促销列表</li>
            </ol>
        </div>
    </div>
    <div id="content">
        <div class="row">
            <div class="col-md-12">
                <div class="panel">
                    <div class="panel-heading"> <span class="panel-title"> <span class="glyphicons glyphicons-group"></span> 促销列表 </span> <div class="topbar-right" style="margin-right: 10px;">
                        <select class="multiselect" id="department_ids" onchange="$('.btn').attr('disabled','disabled');$('#department_ids').attr('disabled','disabled');location.href='/{{routerProjectId}}/seller/promotionlist?expire='+this.value;">
                            <option value="">全部</option>
                            <option value="1" {%if expire==1%} selected {%endif%}>未过期</option>
                            <option value="2" {%if expire==2%} selected {%endif%}>已过期</option>
                        </select>

                        <select class="multiselect" id="department_id" onchange="$('.btn').attr('disabled','disabled');$('#department_id').attr('disabled','disabled');location.href='/{{routerProjectId}}/seller/promotionlist?promotion_status='+this.value;">
                            <option value="">全部账号</option>
                            <option value="1" {%if promotion_status==1%} selected {%endif%}>审核中</option>
                            <option value="2" {%if promotion_status==2%} selected {%endif%}>审核通过</option>
                            <option value="3" {%if promotion_status==3%} selected {%endif%}>审核未通过</option>
                        </select>
                    </div>
                    </div>
                    {{javascript_include('client/pagers.js')}}
                    <div class="panel-body pbn">
                        <table class="table table-striped table-bordered table-hover" id="datatable">
                            <thead>
                            <th style="width:1%">促销图片</th>
                            <th nowrap="">促销主题名</th>
                            <th nowrap="">原价</th>
                            <th nowrap="">现价</th>
                            <th nowrap="">折扣力度</th>
                            <th nowrap="">状态</th>
                            <th nowrap="">简介</th>
                            <th nowrap="">开始时间</th>
                            <th nowrap="">结束时间</th>
                            <th nowrap="">创建时间</th>
                            <th style="width:1%" class="hidden-xs">操作</th>
                            </thead>
                            <tbody>
                            {%for i in promotionList%}
                                <tr id="{{i['wx_promotion_id']}}">
                                <td nowrap="">{%if i['promotion_img']%}<img src="http://apimerchant.signp.cn/{{i['promotion_img']}}"  width="60">{%else%}<img src="/client/crash.png" />{%endif%}</td>
                                <td class="text-left">{{i['promotion_name']}}</td>
                                <td nowrap="">{{i['promotion_original_price']}}</td>
                                <td nowrap="">{{i['promotion_present_price']}}</td>
                                <td nowrap=""><span class="label" style="color: #00a6b6">{{i['promotion_discount']}}折</span></td>
                                <td>
                                    <select id="department_id1" onchange=changestatus({{i['wx_promotion_id']}})>
                                        <option value="1" {%if i['promotion_status']==1%} selected {%endif%}>审核中</option>
                                        <option value="2" {%if i['promotion_status']==2%} selected {%endif%}>审核通过</option>
                                        <option value="3" {%if i['promotion_status']==3%} selected {%endif%}>审核不通过</option>
                                    </select>
                                </td>
                                <td nowrap="" class="detailes" data="{{i['promotion_detailes']}}" style="cursor:pointer;text-decoration:underline"></td>
                                <td nowrap>{%if i['promotion_start_time']%}{{date("Y-m-d",i['promotion_start_time'])}}{%else%}---{%endif%}</td>
                                <td nowrap>{%if i['promotion_end_time']%}{{date("Y-m-d",i['promotion_end_time'])}}{%else%}---{%endif%}</td>
                                <td nowrap>{%if i['promotion_create_at']%}{{date("Y-m-d",i['promotion_create_at'])}}{%else%}---{%endif%}</td>
                                <td nowrap>
                                    <button type="button" class="btn btn-default btn-gradient btn-xs deleteBtn" data-id="{{i['wx_promotion_id']}}" style="margin-left: 10px">删除</button>
                                </td>
                            </tr>
                            {%endfor%}
                            </tbody>
                        </table>
                        <script language="JavaScript">var pg = new showPages('pg');pg.pageCount = {{pageCount}};pg.printHtml();</script>
                    </div>
                </div>

            </div>
        </div>
        <div class="contentBg" style="position: absolute;left: 0;top: 0;background: rgba(0,0,0,.4);width: 100%;height: 100%;z-index: 99;display: none">
            <div class="cen" style="position: absolute;width: 50%;margin: 10% 25% 35% 25%;height: 20%;background: #ffffff;border: 2px solid rgba(0,0,0,.5);border-radius: 5px;text-align: left;padding: 20px 30px"></div>
        </div>
    </div>

</section>

{{partial ("layout/footer")}}
{{javascript_include('client/vendor/plugins/multiselect/bootstrap-multiselect.js')}}
{{javascript_include('client/vendor/plugins/datatables/js/jquery.dataTables.min.js')}}
{{javascript_include('client/vendor/plugins/datatables/js/datatables.js')}}
{{javascript_include('client/vendor/plugins/datatables/extras/TableTools/media/js/TableTools.min.js')}}
{{javascript_include('client/vendor/plugins/datatables/extras/TableTools/media/js/ZeroClipboard.js')}}

{{javascript_include('client/js/main.js')}}

<style>
    #datatable_wrapper #datatable_paginate{display:none;}
</style>
<script type="text/javascript">
    function changestatus(wx_promotion_id) {
        var promotion_status = $('#department_id1').find("option:selected").val();
        $.ajax('/{{routerProjectId}}/seller/ajaxchangestatus', {
            data: {
                wx_promotion_id:wx_promotion_id,
                promotion_status:promotion_status
            },
            type: 'post',
            dataType: 'json',
            success: function(data)
            {
                if (data.errcode == 0)
                {
                    alert('修改成功');
                    location.href ='/{{routerProjectId}}/seller/promotionlist?promotion_status='+promotion_status;
                }
            },
            error: function()
            {
                alert('服务器错误');
            },
        });
    }


    function deletepromotion(id){
       $('.btn').attr('disabled','disabled');
        $.ajax('/{{routerProjectId}}/seller/ajaxdeletepromotion', {
            data: {
                wx_promotion_id:id,
            },
            type: 'post',
            dataType: 'json',
            success: function(data)
            {
                if (data.errcode == 0)
                {
                    alert('删除成功');
                    location.href = location.href;
                    $('#loadings').remove();
                }
            },
            error: function()
            {
                alert('服务器错误');
            },
            complete:function(){
                $('.btn').removeAttr('disabled');
            }
        });
    }

    jQuery(document).ready(function () {
        "use strict";
        // Init Theme Core
        Core.init();

        $('.detailes').each(function(){
            var res = $(this).attr('data');
            res = (res.substring(0,15));
            $(this).html(res+'......');
        })
        $('.detailes').click(function(){
            $('.contentBg').show();
            var res = $(this).attr('data');
            $('.cen').html(res);
        })
        $('.contentBg').click(function () {
            $(this).hide();
            $(".cen").click(function(event){
                event.stopPropagation();
            });
        })
        $('.deleteBtn').each(function(){
            $(this).on('click',function(){
                if (confirm("确定要删除？")){
                    $(this).parent().append('{{image("https://signposs1.oss-cn-shenzhen.aliyuncs.com/oss/Images/Icons/Load/load-7.gif",'id':'loadings' ,'width':'20')}}');
                    deletepromotion($(this).attr('data-id'))
                }
            });
        })
        // $('.multiselect').multiselect({enableFiltering: true,maxHeight: 420,buttonWidth:"200px"});
        $('#datatable').dataTable({
            "aoColumnDefs": [{ 'bSortable': false, 'aTargets': [ -1 , 0 , 1,2 ] }],
            "oLanguage": { "oPaginate": {"sPrevious": "", "sNext": ""} },
            "iDisplayLength": 10,
            "aLengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "sDom": '<"panel-menu dt-panelmenu"lfr><"clearfix">tip',
        });
        $('.dataTables_filter input').attr("placeholder", "搜索");

    });

</script>

</body>
</html>
