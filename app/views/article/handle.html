{{partial("layout/header")}}
<style>
.conditionalPart{display: none}
</style>
<section id="content_wrapper">
    <div id="topbar">
      <div class="topbar-left">
        <ol class="breadcrumb">
          <li class="crumb-active"><a href="#">{{"ArticleHandle"|_}}</a></li>
          <li class="crumb-icon"><a href="/"><span class="glyphicon glyphicon-home"></span></a></li>
          <li class="crumb-link"><a href="/">{{"Home"|_}}</a></li>
          <li class="crumb-trail">{%if details['article_id'] is defined%}{{"ArticleEdit"|_}}{%else%}{{"ArticleCreate"|_}}{%endif%}</li>
        </ol>
      </div>
    </div>
    <div id="content">
      <div class="row">
<div class="col-md-12">
<div class="panel"><div class="panel-heading"> <span class="panel-title"> <span class="glyphicon glyphicon-file"></span> {%if details['article_id'] is defined%}{{"ArticleEdit"|_}}{%else%}{{"ArticleCreate"|_}}{%endif%} </span> </div>
            <div class="panel-body">
              <form class="cmxform" id="altForm">
              <input type="hidden" id="article_id" value="{%if details['article_id'] is defined%}{{details['article_id']}}{%endif%}" />
                <div class="form-group">
                  <label>{{"AritcleTitle"|_}}</label>
                  <input id="title" name="title" type="text" class="form-control" autocomplete="off" required="" value="{%if details is defined%}{{details["article_title"]}}{%endif%}">
                </div>
                <div class="form-group">
                  <label>{{"Thumbnail"|_}}</label> <span>(大小限制 100KB)</span>
                  <div style="margin: 6px;display: none;" id="previewDiv"><a href="" target="_blank" id="previewImageUrl"><img src="" width="100" id="previewImage" /></a> <button type="button" class="btn btn-info btn-gradient btn-xs" style="margin-left: 30px;" onclick="removeImage()">remove image</button><input type="hidden" id="article_icon" value="">
</div>
                  <div class="progress progress-striped active" style="height: 3px;margin-bottom: 0px">
                        <div class="progress-bar" role="progressbar" id="thumbnailProgress" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"> <span class="sr-only">45% Complete</span> </div>
                      </div>
                  <input id="thumbnail" name="thumbnail" type="file" class="form-control" multiple onchange="UpLoadFile()" >
                </div>
                <div class="form-group">
                  <label>{{"ArticleDigest"|_}}</label>
                  <input id="digest" name="digest" type="text" class="form-control" autocomplete="off" value="{%if details is defined%}{{details["article_digest"]}}{%endif%}">
                </div>
                <div class="form-group">
                  <label>{{"ArticleCategory"|_}}</label>
                  <div class="col-md-13">
                    <select class="multiselect" id="category" required="">
                    <option value="" selected="selected"></option>
                      {%for i in options%}
                      <option value="{{i['id']}}"{%if i['id']==details['article_category_id']%} selected{%endif%}>{{i['item']}}</option>
                      {%endfor%}
                    </select></div>
                </div>
                <div class="form-group">
                  <label>{{"AritcleContent"|_}}</label>
                  <textarea id="article_content" name="article_content" required="">{%if details is defined%}{{details["article_content"]}}{%endif%}</textarea>
                </div>
                <div class="form-group">
                  <label>{{"ArticleLanguage"|_}}</label>
                  <div class="col-md-13">
                    <select class="multiselect" id="language">
                    <option value="zh_CN">中文</option>
                    <option value="en_US">English</option>
                    </select></div>
                </div>
                <div class="form-group">
                  <label>{{"ArticleStatus"|_}}</label>
                  <div class="col-md-13">
                    <select class="multiselect" id="status">
                    <option value="1">发布</option>
                    <option value="0">关闭</option>
                    </select></div>
                </div>
                <div class="form-group">
                  <input class="submit btn bg-purple pull-right" type="submit" id="subBtn" value="{{"Submit"|_}}">
                </div>
              </form>
            </div>
          </div>
</div>
          </div>
        </div>
  </section>

{{partial ("layout/footer")}}
{{javascript_include('client/vendor/plugins/validate/jquery.validate.js')}}
{{javascript_include('client/vendor/plugins/validate/messages_zh.min.js')}}
{{javascript_include('client/vendor/plugins/multiselect/bootstrap-multiselect.js')}}
{{javascript_include('client/vendor/editors/ckeditor/ckeditor.js')}}
{{javascript_include('client/vendor/editors/ckeditor/plugins/plugin_uploadImage.js')}}
{{javascript_include('client/js/main.js')}}
<script type="text/javascript">

var multiselectConfig = {enableFiltering: true,maxHeight: 220,buttonWidth:"200px"};
function bytesToSize(bytes) {
   var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
   if (bytes == 0) return '0 Byte';
   var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
   return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
};
function UpLoadFile() {
        var xhr = new XMLHttpRequest();
        xhr.overrideMimeType('text/plain; charset=utf-8');
        // FormData 对象
        var formData = new FormData();
        var files = document.getElementById('thumbnail').files;
        if (files[0] ==undefined){
            alert("No file chosen")
            return;
        }
        var totalBytes = files[0].size;
        if (totalBytes>102400){
          alert('缩略图文件过大');
          return;
        }
        // $("#userfile").attr("disabled","disabled");
        $("#thumbnail").attr("disabled","disabled");

        formData.set('part', 'article');
        formData.set('Filedata', files[0]);
        // XMLHttpRequest 对象
        xhr.upload.onprogress = function (ev) {
            var percent = 0;
            if (ev.lengthComputable) {
                percent = parseInt(100 * ev.loaded / ev.total);
                $("#thumbnailProgress").width(percent + "%");
            }
        };
        xhr.onreadystatechange = function () {
            if (xhr.readyState==4){
            if (xhr.status == 200) {
              $("#previewImage").attr("src" , xhr.responseText);
              $("#previewImageUrl").attr("href" , xhr.responseText);
              $("#article_icon").val(xhr.responseText);
              $("#previewDiv").show();
              // fileInput.replaceWith(fileInput.val('').clone(true));
            }else{
              alert(xhr.responseText)
            }
        }
        $("#thumbnailProgress").width("0%");
        $('#thumbnail').removeAttr("disabled");
        }
        xhr.open("post", "/{{routerProjectId}}/upload/upload", true);
        xhr.send(formData);
    }
    function removeImage(){
       $("#previewImage").attr("src" , "");
       var fileInput = $('#thumbnail');
      fileInput.replaceWith(fileInput.val('').clone(true));
      $("#previewImageUrl").attr("href" , '');
       $("#previewDiv").hide();
    }
function submitHandler(){
        var content = $.trim(CKEDITOR.instances['article_content'].getData());
        var article_id      = parseInt($('#article_id').val()),
            article_title     = $.trim($('#title').val()),
            article_category_id = $('#category').val(),
            digest        = $.trim($('#digest').val()),
            thumbnail        = $.trim($('#article_icon').val()),
            locale        = $('#language').val(),
            status        = $('#status').val();
            $('#subBtn').attr('disabled', 'disabled');
            $('#subBtn').parent().append('{{image("oss/Images/Icons/Load/load-7.gif" , "width":"20")}}');
            $.ajax('/{{routerProjectId}}/article/handle', {
                data: {
                  article_id      : article_id,
                  article_title     : article_title,
                  article_category_id : article_category_id,
                  article_digest    : digest,
                  article_content   : content,
                  article_icon    : thumbnail,
                  article_locale    : locale,
                  article_status    : status,
                },
                type: 'post',
                dataType: 'json',
                success: function(data)
                {
                  console.log(data)
                    if (data.errcode == 0)
                    {
                      alert('操作成功')
                        location.replace('/{{routerProjectId}}/article/list');
                    }else{
                      alert(data.errmsg);
                    }
                },
                error: function()
                {
                    alert('服务器错误');
                },
                complete:function(){
                  $('#subBtn').removeAttr('disabled');
                }
            });
            return false;
}
jQuery(document).ready(function () {
   "use strict";
     // Init Theme Core
    Core.init();
    var baseImageUrl = '{{url.getStaticBaseUri()}}';
    {%if details is defined%}
    $('#article_id').val('{{details["article_id"]}}');
    $('#category').val('{{details["article_category_id"]}}');
    $('#language').val('{{details["article_locale"]}}');
    $('#status').val('{{details["article_status"]}}');
    {%if details["article_icon"]%}
    {%if details['article_icon_source']=='locale'%}
    baseImageUrl = '/';
    {%endif%}
              $("#previewImageUrl").attr("href" , baseImageUrl+'{{details["article_icon"]}}');
              $("#previewDiv").show();
    $('#previewImage').attr('src',baseImageUrl+'{{details["article_icon"]}}');
    $('#article_icon').val('{{details["article_icon"]}}');
    {%endif%}
    {%endif%}
    $("#altForm").validate({
      submitHandler:submitHandler,
    ignore: [],
    rules: {
                article_content: {
                    required: function() 
                    {
                    CKEDITOR.instances.article_content.updateElement();
                    }
                    }
                },
                errorPlacement: function(error, element) 
                {
                    if (element.attr("name") == "article_content") 
                   {
                    error.insertAfter("textarea#article_content");
                    } else {
                    error.insertAfter(element);
                    }
                }
            });
    CKEDITOR.replace( 'article_content',{
        extraPlugins: 'uploadimage',
        filebrowserImageUploadUrl: '/{{routerProjectId}}/upload/upload?part=client_article',
    });
    // $('.multiselect').multiselect(multiselectConfig);

});

</script>

</body>
</html>
