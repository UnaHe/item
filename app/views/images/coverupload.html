{% extends "layout/main.html" %}

{% block content %}

    <link rel="stylesheet" href="/amazeuidatatables/amazeui.datatables.css"/>
    <div class="tpl-content-page-title am-icon-upload">
        {{"CoverUpload"|_}}
    </div>
    <ol class="am-breadcrumb">
        <li><a href="/" class="am-icon-home">首页</a></li>
        <li>{{"CoverManage"|_}}</li>
        <li class="am-active"><a href="/images/coverupload" >{{"CoverUpload"|_}}</a></li>
    </ol>
    <div class="tpl-portlet-components">
        <div class="row">
            <form class="am-form" id="altForm">
                <fieldset>
                    <div class="am-form-group">
                        <div style="margin: 6px;{{ image['images_path'] is defined ? 'display: block;' : 'display: none;'}}" id="previewDiv">
                            <a href="" target="_blank" id="previewImageUrl">
                                <img src="{{ image['images_path'] is defined ? image['images_path'] : '' }}" width="100" id="previewImage" />
                            </a>
                            <button type="button" class="am-close am-close-alt am-icon-close am-close-spin" style="margin-left: 30px;" onclick="removeImage()"></button>
                            <input type="hidden" id="cover_photo" value="">
                        </div>
                        <div class="am-progress am-progress-xs am-progress-striped am-active">
                            <div class="am-progress-bar am-progress-bar-success" id="thumbnailProgress"></div>
                        </div>
                        <div class="am-form-group am-form-file">
                            <button type="button" class="am-btn am-btn-sm"><i class="am-icon-cloud-upload"></i> 选择要上传的文件</button>
                            <input id="thumbnail" name="thumbnail" type="file" class="form-control" multiple onchange="UpLoadFile()" >
                        </div>
                    </div>
                    <div class="am-form-group">
                        <input class="am-btn am-btn-secondary am-btn-sm am-radius pull-right" type="submit" onclick="savepath()" value="{{"Submit"|_}}">
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
    
    {{javascript_include('client/vendor/plugins/validate/jquery.validate.js')}}
    {{javascript_include('client/vendor/plugins/jquerymask/jquery.maskedinput.min.js')}}
    {{javascript_include('client/vendor/editors/ckeditor/ckeditor.js')}}
    <script type="text/javascript">
        function savepath() {
            var path = $.trim($('#cover_photo').val());
    
            if (!path) {
                alert('请选择需要上传的图片');
                return;
            }
    
            var r = confirm('确定上传图片？');
            if (r == true) {
                $.ajax('/images/coverupload', {
                    type: "POST",
                    dataType: 'JSON',
                    data: {
                        'images_type': 'cover',
                        'images_path': path,
                    },
                    success:function(data){
                        console.log(data);
                        if(data.code == 0) {
                            alert(data.msg);
                            window.location.replace('/images/coverlist');
                        }else if(data.code == 400){
                            alert(data.data);
                        }else{
                            alert(data.msg);
                        }
                    },
                    error:function(){
                        alert('操作失败，请稍后重试！');
                    }
                })
            }
        }
    
        function UpLoadFile() {
            var xhr = new XMLHttpRequest();
            xhr.overrideMimeType('text/plain; charset=utf-8');
            // FormData 对象
            var formData = new FormData();
            var files = document.getElementById('thumbnail').files;
            if (files[0] == undefined) {
                alert("No file chosen");
                return;
            }
    
            //验证图片的格式和尺寸开始
            if (!/.(gif|jpg|png|GIF|JPG|PNG)$/.test($("#thumbnail").val())) {
                alert("图片限于gif,jpg,png格式");
                $("#thumbnail").val("").focus();
                return false;
            }
            //宽高
            getImageWidthAndHeight(files[0], function (obj) {
                var proportion = (obj.width * 1) / (obj.height * 1);
                if (obj.width < 1080 || obj.height < 1920 || proportion < 0.5 || proportion > 0.57) {
                    alert("为了布局美观，请上传宽大于1080px,高不大于1920px，宽高比例为9:16的图片");
                    $("#thumbnail").val("").focus();
                    return false;
                } else {
                    //验证图片的格式和尺寸结束
                    //上传
                    var totalBytes = files[0].size;
                    if (totalBytes > 2097152) {
                        alert("上传图片应小于2兆");
                        return false;
                    }
                    $("#thumbnail").attr("disabled", "disabled");
    
                    formData.set('Filedata', files[0]);
                    formData.set('part','cover');
    
                    // XMLHttpRequest 对象
                    xhr.upload.onprogress = function (ev) {
                        var percent = 0;
                        if (ev.lengthComputable) {
                            percent = parseInt(100 * ev.loaded / ev.total);
                            $("#thumbnailProgress").width(percent + "%");
                        }
                    };
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState == 4) {
                            if (xhr.status == 200) {
                                $("#previewImage").attr("src" , xhr.responseText);
                                $("#previewImageUrl").attr("href" , xhr.responseText);
                                $("#cover_photo").val(xhr.responseText);
                                $("#previewDiv").show();
                            }else{
                                alert(xhr.responseText)
                            }
                        }
                        $("#thumbnailProgress").width("0%");
                        $('#thumbnail').removeAttr("disabled");
                    };
                    xhr.open("post", "/upload/upload", true);
                    xhr.send(formData);
                }
            });
        }
    
        function getImageWidthAndHeight(file, callback) {
            var _URL = window.URL || window.webkitURL;
            var img = new Image();
            img.onload = function () {
                callback && callback({"width": this.width, "height": this.height, "filesize": file.size});
            };
            img.src = _URL.createObjectURL(file);
        }
    
        function removeImage(){
            $("#previewImage").attr("src" , "");
            var fileInput = $('#thumbnail');
            fileInput.replaceWith(fileInput.val('').clone(true));
            $("#previewImageUrl").attr("href" , '');
            $("#previewDiv").hide();
            $("#cover_photo").val('');
        }
    </script>

{% endblock %}