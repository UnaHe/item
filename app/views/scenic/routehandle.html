{{partial("layout/header")}}
<section id="content_wrapper">
    <div id="topbar">
        <div class="topbar-left">
            <ol class="breadcrumb">
                <li class="crumb-active"><a href="#">{{"ScenicRouteHandle"|_}}</a></li>
                <li class="crumb-icon"><a href="/{{routerProjectId}}/index/index"><span
                        class="glyphicon glyphicon-home"></span></a></li>
                <li class="crumb-link"><a href="/{{routerProjectId}}/index/index">{{"Home"|_}}</a></li>
                <li class="crumb-trail">{{"ScenicManage"|_}}</li>
            </ol>
        </div>
    </div>
    <div id="content">
        <div class="row">
            <div class="col-md-12">
                <div class="panel">
                    <div class="panel-body">
                        <div class="form-group">
                            <label>方案名称</label>
                            <input id="routeName" type="text" class="form-control" autocomplete="off" value="{{scenicRouteDetails['scenic_route_name']}}">
                        </div>
                        <div class="form-group">
                            <label class="control-label">路线分类</label>
                            <select class="form-control" id="category">
                                <option value="0"></option>
                                {%for i in scenicRouteCategoryList%}
                                <option value="{{i['scenic_route_category_id']}}"{%if scenicRouteDetails['scenic_route_category_id']==i['scenic_route_category_id']%} selected{%endif%}>{{i['scenic_route_category_name']}}
                                </option>
                                {%endfor%}
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="panel">
                                <div class="panel-heading"><span class="panel-title"> <span
                                        class="glyphicons glyphicons-sort"></span> 景点列表 </span></div>
                                <div class="panel-body">
                                    <table class="table table-striped table-bordered table-hover table table-hover"
                                           id="datatable">
                                        <thead>
                                        <th style="text-align: left">名称</th>
                                        <th nowrap="">选择</th>
                                        </thead>
                                        <tbody>
                                        {%for i in mapPolygonList%}
                                        <tr>
                                            <td style="text-align: left" nowrap="">{{i['name']}}</td>
                                            <td nowrap>
                                                <div class="cBox cBox-teal cBox-inline">
                                                    <input type="checkbox" id="spot_{{i['map_polygon_id']}}"
                                                           class="spotCheck" data-name="{{i['name']}}"
                                                           data-map_id="{{i['map_id']}}"
                                                           data-gid="{{i['gid']}}"
                                                           value="{{i['map_polygon_id']}}"{%if i['checked'] is defined%} checked{%endif%}>
                                                    <label for="spot_{{i['map_polygon_id']}}"></label>
                                                </div>
                                            </td>
                                        </tr>

                                        {%endfor%}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                        <div class="col-md-4">
                            <div class="panel">
                                <div class="panel-heading"><span class="panel-title"> <span
                                        class="glyphicons glyphicons-sort"></span> 路线规划 </span>( 景点可拖拽，按顺序显示 )
                                </div>
                                <div class="panel-body">
                                    <div id="nestable1" class="nestable-white dd">
                                        <ol class="dd-list">
                                            {%if routeContent is defined%}
                                            {%for i in routeContent%}
                                            <li class="dd-item" data-id="{{i[0]}}" data-map_id="{{i[1]}}" data-gid="{{i[2]}}" data-name="{{i[3]}}"><div class="dd-handle">{{i[3]}}</div></li>
                                            {%endfor%}
                                            {%endif%}
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <button class="submit btn btn-info pull-right ladda-button" id="subBtn"
                                    data-style="expand-left"><span class="ladda-label">{{"Save"|_}}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{{partial ("layout/footer")}}
{{javascript_include('client/vendor/plugins/nestable/jquery.nestable.js')}}
{{javascript_include('client/vendor/plugins/ladda/ladda.min.js')}}
{{javascript_include('client/vendor/plugins/datatables/js/jquery.dataTables.min.js')}}
{{javascript_include('client/vendor/plugins/datatables/js/datatables.js')}}
<script type="text/javascript" src="https://signposs1.oss-cn-shenzhen.aliyuncs.com/client/js/main.js"></script>
<script type="text/javascript">
    jQuery(document).ready(function () {
        "use strict";
        // Init Theme Core
        Core.init();

        $('.spotCheck').on('click', function () {
            if (this.checked) {
                $('.dd-list').append('<li class="dd-item" data-id="' + this.value + '" data-map_id="' + $(this).attr('data-map_id')+ '" data-gid="' + $(this).attr('data-gid') + '" data-name="' + $(this).attr('data-name') + '"><div class="dd-handle">' + $(this).attr('data-name') + '</div></li>');
            } else {
                $('.dd-list [data-id=' + this.value + ']').remove();
            }
        });

        $('#nestable1').nestable({maxDepth: 1});

        $('#datatable').dataTable({
            "aoColumnDefs": [{'bSortable': false, 'aTargets': [-1, 0]}],
            "oLanguage": {"oPaginate": {"sPrevious": "", "sNext": ""}},
            "iDisplayLength": 20,
            "aLengthMenu": [[20, 30, 50, -1], [20, 30, 50, "All"]],
            "sDom": '<"panel-menu dt-panelmenu"lfr><"clearfix">tip',
        });
        $('.dataTables_filter input').attr("placeholder", "搜索");

        $('#subBtn').bind('click', function () {
            var name = $.trim($('#routeName').val());
            var category_id = $('#category').val();
            var data = '';
            var dataCount = 0;
            if (name === '' || category_id === '0') {
                alert('请填写完整');
                return;
            }
            $('.dd-item').each(function () {
                data += $(this).attr('data-id') + ',' + $(this).attr('data-map_id') + ','+ $(this).attr('data-gid') + ',' + $(this).attr('data-name') + ';'
                dataCount++;
            });
            console.log(data);
            if (data === '') {
                alert('请选择景点规划路线');
                return;
            }
            if (dataCount <= 1) {
                alert('推荐路线至少需要 2 个景点');
                return;
            }
            var l = Ladda.create(document.querySelector('#subBtn'));
            l.start();
            $.ajax('/{{routerProjectId}}/scenic/routehandle', {
                data: {
                    id:'{{scenicRouteDetails['scenic_route_id']}}',
                    name: name,
                    category_id: category_id,
                    data: data
                },
                type: 'post',
                dataType: 'json',
                success: function (data) {
                    alert(data.errmsg);
                    if (data.errcode == 0) {
                        location.replace('/{{routerProjectId}}/scenic/route');
                    }
                    l.stop();
                },
                error: function () {
                    alert('服务器错误');
                    l.stop();
                }
            });
        });

    });

</script>

</body>
</html>
